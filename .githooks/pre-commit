#!/bin/bash
# Pre-commit hook for ypi
# Safety net for direct git usage. jj bypasses this entirely.
#
# Install: git config core.hooksPath .githooks

# --- Gitleaks: scan staged changes for secrets ---
if command -v gitleaks &>/dev/null; then
    gitleaks protect --staged --no-banner
    if [ $? -ne 0 ]; then
        echo "⛔ gitleaks detected secrets in staged files!" >&2
        echo "Fix the leak or add to .gitleaksignore if it's a false positive." >&2
        exit 1
    fi
else
    echo "⚠️  gitleaks not installed — skipping secret scan" >&2
fi

# --- Block unencrypted files in sops-managed paths ---
for file in $(git diff --cached --name-only | grep -E '^(private/|\.prose/runs/|\.prose/agents/)'); do
    if [ ! -f "$file" ]; then
        continue
    fi
    if ! head -1 "$file" | grep -q '"data": "ENC\[' 2>/dev/null && \
       ! head -5 "$file" | grep -q '"sops"' 2>/dev/null; then
        echo "⛔ $file is unencrypted! Run: scripts/encrypt-prose" >&2
        exit 1
    fi
done

exit 0
